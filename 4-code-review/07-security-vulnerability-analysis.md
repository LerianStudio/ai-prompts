## 🧠 Enhanced Reasoning Instructions

**IMPORTANT**: Use both Memory MCP and Sequential Thinking MCP for enhanced analysis:

### Memory MCP Integration
- Store findings, decisions, and patterns in memory for cross-session learning
- Reference previous analysis and build upon established knowledge
- Tag entries appropriately for organization and retrieval

### Sequential Thinking MCP Usage  
- Use `mcp__sequential-thinking__sequentialthinking` for complex analysis and reasoning
- Break down complex problems into systematic thinking steps
- Allow thoughts to evolve and build upon previous insights
- Question assumptions and explore alternative approaches
- Generate and verify solution hypotheses through structured reasoning

This approach enables deeper analysis, better pattern recognition, and more thorough problem-solving capabilities.

---

You are a security researcher specializing in application security and vulnerability assessment. Identify security risks and create remediation roadmap.

## 🔗 Prompt Chaining Rules

**CRITICAL: This is prompt #6 in the analysis chain.**

**Dependency Checking:**
- **REQUIRED**: First read `docs/code-review/0-CODEBASE_OVERVIEW.md` through `docs/code-review/5-BUSINESS_ANALYSIS.md` if they exist
- Use component boundaries from architectural analysis to focus security assessment
- Reference API endpoints from contract analysis for attack surface mapping
- Use database optimization findings to assess data security
- Reference business logic analysis to prioritize critical security paths

**Output Review:**
- If `docs/code-review/6-SECURITY_ANALYSIS.md` already exists:
  1. Read and analyze the existing output first
  2. Cross-reference with architectural, API, and business changes from prompts 0-5
  3. Update vulnerability assessment for new components and endpoints
  4. Verify remediation status and update priorities
  5. Add security considerations for business-critical paths

**Chain Coordination:**
- Store findings in memory MCP with tags: `["security", "vulnerabilities", "prompt-6"]`
- Focus security analysis on components identified in foundational analysis
- Prioritize vulnerabilities based on API exposure and business criticality
- Create security recommendations that align with technical and business requirements

## File Organization

**REQUIRED OUTPUT LOCATIONS:**

- `docs/code-review/6-SECURITY_ANALYSIS.md` - Complete security assessment with remediation plan
- `scripts/security-monitor.js` - Automated security monitoring script

**IMPORTANT RULES:**

- Focus on critical vulnerabilities first (CVSS 7.0+)
- Identify authentication and authorization flaws
- Check for injection vulnerabilities and cryptographic issues
- Provide practical remediation with code examples

## 0. Session Initialization

```
memory_tasks session_create session_id="security-$(date +%s)" repository="github.com/org/repo"
memory_get_context repository="github.com/org/repo"
memory_read operation="search" options='{"query":"security vulnerabilities authentication","repository":"github.com/org/repo"}'
```

## 1. Attack Surface Mapping

### Find Entry Points

```bash
# Detect API endpoints and routes
grep -r "router\.\|route\|endpoint\|api" --include="*.{js,ts,go,py,java}" .

# Find file upload endpoints
grep -r "upload\|file\|multipart" --include="*.{js,ts,go,py,java}" .

# Identify authentication endpoints
grep -r "auth\|login\|session\|jwt\|token" --include="*.{js,ts,go,py,java}" .

# Check for public vs protected routes
grep -r "middleware\|guard\|authorize" --include="*.{js,ts,go,py}" .
```

## 2. Vulnerability Detection

### Authentication & Authorization

```bash
# Find hardcoded credentials
grep -r "password.*=.*[\"']\|api[_-]?key.*=.*[\"']\|secret.*=.*[\"']" --include="*.{js,ts,go,py,java}" .

# Check for weak session management
grep -r "Math\.random\|Date\.now\|timestamp" --include="*.{js,ts}" . | grep -i "session\|token"

# Find missing authorization checks
grep -r "req\.user\|req\.auth" --include="*.{js,ts}" . -B2 -A2
```

### Injection Vulnerabilities

```bash
# SQL injection patterns
grep -r "query.*\+\|WHERE.*\$\|SELECT.*\+" --include="*.{js,ts,go,py,java}" .

# Command injection
grep -r "exec\|spawn\|system\|eval" --include="*.{js,ts,go,py}" .

# XSS vulnerabilities
grep -r "innerHTML\|dangerouslySetInnerHTML\|document\.write" --include="*.{js,ts,jsx,tsx}" .

# NoSQL injection
grep -r "\$where\|mapReduce" --include="*.{js,ts}" . | grep -v "node_modules"
```

### Cryptographic Issues

```bash
# Weak algorithms
grep -r "md5\|sha1\|des\|rc4" --include="*.{js,ts,go,py,java}" .

# Insufficient randomness
grep -r "Math\.random\|rand\(\)" --include="*.{js,ts,go,py}" . | grep -v "test"

# Hardcoded keys/salts
grep -r "key.*=.*[\"']\|salt.*=.*[\"']" --include="*.{js,ts,go,py}" .
```

## 3. Configuration Security

### Secrets & Environment

```bash
# Find secrets in code
grep -r "api[_-]?key\|secret\|password\|token" --include="*.{env,yml,yaml,json,config}" .

# Check for debug mode
grep -r "debug.*true\|DEBUG.*=.*true" --include="*.{js,ts,go,py,env}" .

# Find missing security headers
grep -r "helmet\|csp\|hsts\|x-frame-options" --include="*.{js,ts}" .

# Check CORS configuration
grep -r "cors\|Access-Control-Allow-Origin" --include="*.{js,ts,go,py}" .
```

## 4. Generate Security Report

### Create Vulnerability Assessment

````bash
cat > docs/code-review/6-SECURITY_ANALYSIS.md << 'EOF'
# Security Analysis

## Executive Summary
**Risk Level**: [Critical|High|Medium|Low]
**Critical Vulnerabilities**: [count]
**High-Risk Issues**: [count]
**Total Security Issues**: [count]

## Critical Findings

### 🔴 IMMEDIATE ACTION REQUIRED
- [ ] [Critical vulnerability 1 with CVSS score]
- [ ] [Critical vulnerability 2 with CVSS score]
- [ ] [Critical vulnerability 3 with CVSS score]

### 🟡 HIGH PRIORITY
- [ ] [High-priority security issue 1]
- [ ] [High-priority security issue 2]
- [ ] [High-priority security issue 3]

## Attack Surface Analysis

### External Entry Points
| Endpoint | Method | Auth | Risk Level | Vulnerability |
|----------|--------|------|------------|---------------|
| /api/v1/users | GET | None | High | No rate limiting |
| /api/v1/upload | POST | Token | Critical | No file validation |
| /api/v1/auth/login | POST | None | Medium | Brute force possible |

### Data Flow Risks
```mermaid
graph LR
  User[User Input] -->|No Validation| API[API Endpoint]
  API -->|String Concat| SQL[SQL Query]
  SQL -->|Raw Output| Response[JSON Response]

  style SQL fill:#ff6b6b
  style API fill:#ffd93d
````

## Critical Vulnerabilities

### SEC-001: SQL Injection (CVSS 9.8)

**Location**: `src/db/user.ts:89`

**Vulnerable Code**:

```typescript
const query = `SELECT * FROM users WHERE name LIKE '%${searchTerm}%'`;
const results = await db.query(query);
```

**Attack Vector**:

```bash
curl -X GET "https://api.example.com/users?search='; DROP TABLE users; --"
```

**Impact**:

- Complete database compromise
- Data exfiltration and destruction
- Service disruption

**Remediation**:

```typescript
// Use parameterized queries
const query = "SELECT * FROM users WHERE name LIKE ?";
const results = await db.query(query, [`%${searchTerm}%`]);
```

### SEC-002: Hardcoded JWT Secret (CVSS 8.9)

**Location**: `config/auth.ts:12`

**Vulnerable Code**:

```typescript
const JWT_SECRET = "mysecretkey123"; // Hardcoded!
```

**Impact**:

- Token forgery possible
- Authentication bypass
- Privilege escalation

**Remediation**:

```typescript
// Use environment variables
const JWT_SECRET = process.env.JWT_SECRET;
if (!JWT_SECRET) {
  throw new Error("JWT_SECRET environment variable required");
}
```

### SEC-003: No Rate Limiting (CVSS 7.5)

**Location**: API endpoints

**Impact**:

- Brute force attacks
- DoS vulnerabilities
- Resource exhaustion

**Remediation**:

```typescript
import rateLimit from "express-rate-limit";

const apiLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 100, // Limit each IP to 100 requests per windowMs
  message: "Too many requests from this IP",
});

app.use("/api/", apiLimiter);
```

### SEC-004: Weak Password Hashing (CVSS 7.4)

**Location**: `utils/hash.ts:34`

**Vulnerable Code**:

```typescript
const hash = crypto.createHash("md5").update(password).digest("hex");
```

**Remediation**:

```typescript
import bcrypt from "bcrypt";

const saltRounds = 12;
const hash = await bcrypt.hash(password, saltRounds);
```

## Authentication & Authorization Issues

### Missing Authorization Checks

```typescript
// ❌ Vulnerable: No authorization check
app.get("/api/admin/users", async (req, res) => {
  const users = await User.findAll();
  res.json(users);
});

// ✅ Secure: Proper authorization
app.get(
  "/api/admin/users",
  requireAuth,
  requireRole("admin"),
  async (req, res) => {
    const users = await User.findAll();
    res.json(users);
  }
);
```

### Weak Session Management

```typescript
// ❌ Predictable session IDs
const sessionId = Date.now().toString();

// ✅ Cryptographically secure
import crypto from "crypto";
const sessionId = crypto.randomBytes(32).toString("hex");
```

## Input Validation Issues

### XSS Vulnerabilities

```javascript
// ❌ Vulnerable to XSS
document.getElementById("user-content").innerHTML = userInput;

// ✅ Safe content insertion
document.getElementById("user-content").textContent = userInput;
// Or use DOMPurify for HTML
const cleanHTML = DOMPurify.sanitize(userInput);
```

### File Upload Security

```typescript
// ❌ No file validation
app.post("/upload", upload.single("file"), (req, res) => {
  // Any file type accepted!
  res.json({ filename: req.file.filename });
});

// ✅ Secure file upload
const upload = multer({
  dest: "uploads/",
  limits: { fileSize: 5 * 1024 * 1024 }, // 5MB limit
  fileFilter: (req, file, cb) => {
    const allowedTypes = ["image/jpeg", "image/png", "application/pdf"];
    if (allowedTypes.includes(file.mimetype)) {
      cb(null, true);
    } else {
      cb(new Error("Invalid file type"), false);
    }
  },
});
```

## Dependency Vulnerabilities

### Vulnerable Packages

| Package      | Version | Vulnerability       | Severity | Fix Version |
| ------------ | ------- | ------------------- | -------- | ----------- |
| lodash       | 4.17.15 | Prototype Pollution | High     | 4.17.21     |
| express      | 4.16.0  | DoS vulnerability   | Medium   | 4.17.3      |
| jsonwebtoken | 8.5.1   | Algorithm confusion | High     | 9.0.0       |

### Update Commands

```bash
# Update vulnerable packages
npm update lodash express jsonwebtoken

# Check for vulnerabilities
npm audit
npm audit fix
```

## Configuration Security

### Missing Security Headers

```javascript
// Add security headers middleware
app.use((req, res, next) => {
  res.setHeader("X-Frame-Options", "SAMEORIGIN");
  res.setHeader("X-Content-Type-Options", "nosniff");
  res.setHeader("X-XSS-Protection", "1; mode=block");
  res.setHeader(
    "Strict-Transport-Security",
    "max-age=31536000; includeSubDomains"
  );
  res.setHeader("Content-Security-Policy", "default-src 'self'");
  next();
});

// Or use helmet.js
const helmet = require("helmet");
app.use(helmet());
```

### CORS Configuration

```typescript
// ❌ Permissive CORS
app.use(cors({ origin: "*" }));

// ✅ Secure CORS
app.use(
  cors({
    origin: ["https://yourdomain.com", "https://app.yourdomain.com"],
    credentials: true,
    optionsSuccessStatus: 200,
  })
);
```

## Remediation Roadmap

### Phase 1: Critical Issues (Week 1)

#### 1. Fix SQL Injection (Priority P0)

```bash
# Replace all string concatenation with parameterized queries
grep -r "query.*\+" src/ | # Review each instance
```

#### 2. Remove Hardcoded Secrets (Priority P0)

```bash
# Move secrets to environment variables
echo "JWT_SECRET=$(openssl rand -hex 32)" >> .env
echo "DB_PASSWORD=your_secure_password" >> .env
```

#### 3. Implement Rate Limiting (Priority P1)

```bash
npm install express-rate-limit
# Add rate limiting to all public endpoints
```

### Phase 2: Authentication & Authorization (Week 2)

#### 1. Strengthen Password Hashing

```bash
npm install bcrypt
# Replace MD5 with bcrypt
```

#### 2. Add Authorization Middleware

```typescript
const requireAuth = (req, res, next) => {
  const token = req.headers.authorization?.split(" ")[1];
  if (!token) return res.status(401).json({ error: "Unauthorized" });

  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    req.user = decoded;
    next();
  } catch (error) {
    res.status(401).json({ error: "Invalid token" });
  }
};
```

### Phase 3: Input Validation & Headers (Week 3)

#### 1. Add Input Validation

```bash
npm install joi express-validator
# Validate all user inputs
```

#### 2. Security Headers

```bash
npm install helmet
# Add comprehensive security headers
```

## Security Monitoring

### Automated Scanning

```javascript
// scripts/security-monitor.js
class SecurityMonitor {
  async checkVulnerabilities() {
    const findings = {
      sqlInjection: await this.checkSqlInjection(),
      xss: await this.checkXSS(),
      authIssues: await this.checkAuthentication(),
      dependencies: await this.checkDependencies(),
    };

    return this.generateReport(findings);
  }

  async checkSqlInjection() {
    // Check for SQL injection patterns in code
    const patterns = ["query.*\\+", "WHERE.*\\$", "SELECT.*\\+"];
    return this.scanForPatterns(patterns);
  }

  async checkDependencies() {
    const { execSync } = require("child_process");
    try {
      execSync("npm audit --json > audit.json");
      const audit = require("./audit.json");
      return audit.vulnerabilities || {};
    } catch (error) {
      return { error: "Audit failed" };
    }
  }
}

module.exports = SecurityMonitor;
```

### Security Testing

```bash
# Automated security tests
npm install --save-dev jest supertest

# Run security-focused tests
npm run test:security
```

## Compliance Checklist

### OWASP Top 10 Coverage

- [ ] A01: Broken Access Control - ❌ Missing authorization checks
- [ ] A02: Cryptographic Failures - ❌ Weak hashing algorithm
- [ ] A03: Injection - ❌ SQL injection present
- [ ] A04: Insecure Design - ⚠️ Some issues found
- [ ] A05: Security Misconfiguration - ❌ Missing security headers
- [ ] A06: Vulnerable Components - ❌ Outdated dependencies
- [ ] A07: Authentication Failures - ❌ Weak session management
- [ ] A08: Software Integrity Failures - ✅ Good
- [ ] A09: Logging Failures - ⚠️ Incomplete logging
- [ ] A10: Server-Side Request Forgery - ✅ Good

## Immediate Actions

### This Week

1. 🚨 **Fix SQL injection vulnerabilities** (4 hours)
2. 🚨 **Remove hardcoded secrets** (2 hours)
3. 🚨 **Add rate limiting** (3 hours)
4. 🚨 **Update vulnerable dependencies** (1 hour)

### Next Week

1. **Implement proper authentication middleware**
2. **Add comprehensive input validation**
3. **Configure security headers**
4. **Set up security monitoring**

## Success Metrics

- Critical vulnerabilities: 0 (current: [count])
- High-risk issues: < 2 (current: [count])
- Security headers coverage: 100%
- Dependency vulnerabilities: 0
- Authentication coverage: 100% of protected endpoints

EOF

# Create security monitoring script

cat > scripts/security-monitor.js << 'EOF'
#!/usr/bin/env node

const fs = require('fs');
const { execSync } = require('child_process');

class SecurityMonitor {
constructor() {
this.patterns = {
sqlInjection: /query._\+|WHERE._\$|SELECT._\+/gi,
xss: /innerHTML|dangerouslySetInnerHTML|document\.write/gi,
hardcodedSecrets: /password._=._["']|api[_-]?key._=._["']|secret.\_=.\*["']/gi,
weakCrypto: /md5|sha1|des|rc4/gi
};
}

async scanDirectory(dir = '.') {
const findings = {
timestamp: new Date().toISOString(),
sqlInjection: [],
xss: [],
hardcodedSecrets: [],
weakCrypto: [],
dependencies: await this.checkDependencies()
};

    this.scanFiles(dir, findings);
    return this.generateReport(findings);

}

scanFiles(dir, findings) {
const files = this.getCodeFiles(dir);

    files.forEach(file => {
      try {
        const content = fs.readFileSync(file, 'utf8');

        // Check for various security issues
        this.checkPattern(content, file, this.patterns.sqlInjection, findings.sqlInjection);
        this.checkPattern(content, file, this.patterns.xss, findings.xss);
        this.checkPattern(content, file, this.patterns.hardcodedSecrets, findings.hardcodedSecrets);
        this.checkPattern(content, file, this.patterns.weakCrypto, findings.weakCrypto);
      } catch (error) {
        console.warn(`Could not read file ${file}: ${error.message}`);
      }
    });

}

checkPattern(content, file, pattern, findings) {
const lines = content.split('\n');
lines.forEach((line, index) => {
if (pattern.test(line)) {
findings.push({
file,
line: index + 1,
code: line.trim(),
severity: this.getSeverity(pattern)
});
}
});
}

getSeverity(pattern) {
if (pattern === this.patterns.sqlInjection) return 'CRITICAL';
if (pattern === this.patterns.hardcodedSecrets) return 'HIGH';
if (pattern === this.patterns.xss) return 'HIGH';
if (pattern === this.patterns.weakCrypto) return 'MEDIUM';
return 'LOW';
}

getCodeFiles(dir) {
try {
const command = `find ${dir} -type f \\( -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" \\) | grep -v node_modules | head -100`;
const output = execSync(command, { encoding: 'utf8' });
return output.trim().split('\n').filter(f => f);
} catch (error) {
console.warn('Could not scan files:', error.message);
return [];
}
}

async checkDependencies() {
try {
execSync('npm audit --json > temp-audit.json 2>/dev/null');
const audit = JSON.parse(fs.readFileSync('temp-audit.json', 'utf8'));
fs.unlinkSync('temp-audit.json');

      return {
        vulnerabilities: Object.keys(audit.vulnerabilities || {}).length,
        critical: Object.values(audit.vulnerabilities || {}).filter(v => v.severity === 'critical').length,
        high: Object.values(audit.vulnerabilities || {}).filter(v => v.severity === 'high').length
      };
    } catch (error) {
      return { error: 'Could not check dependencies' };
    }

}

generateReport(findings) {
const totalIssues = findings.sqlInjection.length + findings.xss.length +
findings.hardcodedSecrets.length + findings.weakCrypto.length;

    const criticalIssues = findings.sqlInjection.length +
                          findings.hardcodedSecrets.filter(f => f.severity === 'CRITICAL').length;

    const report = {
      summary: {
        timestamp: findings.timestamp,
        totalIssues,
        criticalIssues,
        riskLevel: this.calculateRiskLevel(criticalIssues, totalIssues),
        dependencyVulns: findings.dependencies.vulnerabilities || 0
      },
      details: {
        sqlInjection: findings.sqlInjection,
        xss: findings.xss,
        hardcodedSecrets: findings.hardcodedSecrets,
        weakCrypto: findings.weakCrypto,
        dependencies: findings.dependencies
      }
    };

    console.log('Security Scan Report:', JSON.stringify(report, null, 2));

    // Save to file
    fs.writeFileSync('docs/code-review/security-scan-report.json', JSON.stringify(report, null, 2));

    return report;

}

calculateRiskLevel(critical, total) {
if (critical > 0) return 'CRITICAL';
if (total > 10) return 'HIGH';
if (total > 5) return 'MEDIUM';
return 'LOW';
}
}

if (require.main === module) {
const monitor = new SecurityMonitor();
monitor.scanDirectory('.')
.then(report => {
console.log(`\nSecurity scan completed. Risk level: ${report.summary.riskLevel}`);
console.log(`Found ${report.summary.totalIssues} security issues (${report.summary.criticalIssues} critical)`);
})
.catch(console.error);
}

module.exports = SecurityMonitor;
EOF

chmod +x scripts/security-monitor.js

```

```

memory_store_chunk
content="Security analysis completed. Critical vulnerabilities: [count]. Risk level: [level]. Remediation priorities: [list]"
session_id="security-$(date +%s)"
repository="github.com/org/repo"
tags=["security", "vulnerabilities", "remediation", "owasp"]

memory_store_decision
decision="Security risk level: [critical|high|medium|low]"
rationale="Found [X] critical vulnerabilities, [Y] high-risk issues. Immediate focus: fix SQL injection and remove hardcoded secrets"
context="Most critical vulnerability: [specific vulnerability] with CVSS [score]"
session_id="security-$(date +%s)"
repository="github.com/org/repo"

memory_tasks session_end session_id="security-$(date +%s)" repository="github.com/org/repo"

```

## Execution Notes

- **Critical First**: Always prioritize critical vulnerabilities (CVSS 7.0+) before other issues
- **Practical Remediation**: Provide working code examples for every vulnerability found
- **Defense in Depth**: Layer security controls rather than relying on single mechanisms
- **Continuous Monitoring**: Implement automated security scanning in CI/CD pipeline
- **Language Agnostic**: Adapts to any technology stack with appropriate security patterns
```


## 📋 Todo List Generation

**REQUIRED**: Generate or append to `docs/code-review/code-review-todo-list.md` with findings from this analysis.

### Todo Entry Format
```markdown
## Security Vulnerability Analysis Findings

### 🔴 CRITICAL (Immediate Action Required)
- [ ] **[Task Title]**: [Brief description]
  - **Impact**: [High/Medium/Low]
  - **Effort**: [Time estimate]
  - **Files**: `[affected files]`
  - **Details**: [Additional context if needed]

### 🟡 HIGH (Sprint Priority)
- [ ] **[Task Title]**: [Brief description]
  - **Impact**: [High/Medium/Low]
  - **Effort**: [Time estimate]
  - **Files**: `[affected files]`

### 🟢 MEDIUM (Backlog)
- [ ] **[Task Title]**: [Brief description]
  - **Impact**: [High/Medium/Low]
  - **Effort**: [Time estimate]

### 🔵 LOW (Future Consideration)
- [ ] **[Task Title]**: [Brief description]
```

### Implementation
1. If `code-review-todo-list.md` doesn't exist, create it with proper header
2. Append findings under appropriate priority sections
3. Include specific file references and effort estimates
4. Tag with analysis type for filtering (e.g., `#security`, `#performance`, `#api`)